worker_processes 1;

events { worker_connections 1024; }

error_log /proc/self/fd/2;
pid /var/run/nginx/nginx.pid;

http {
  # server {
  #   listen 4000;
  #   return 301 https://$host$request_uri;
  # }

  server {
    include /etc/nginx/mime.types;

    server_name convox.com;
    listen 4001;

    access_log /proc/self/fd/1;
    error_log /proc/self/fd/2;

    error_page 404 /error/404/index.html;

    root /app/_site;

    location / {
      try_files $uri $uri/index.html $uri/ =404;
    }

    location /docs/ {
      try_files $uri $uri/index.html $uri/ =404;
      error_page 404 /docs/404/index.html;
    }

    # location ~* \.(css|js|html)$ {
    #   expires max;
    # }

    #####
    # redirects for old, broken links observed with:
    # $ convox logs --app site-production --filter='GET 404' --since=48h --follow=false | cut -d" " -f9 | sort -u

    location /blog/2015/10/08/rack-0.6.html                                     { return 301 https://$host/blog/rack-0.6/ ; }
    location /blog/2015/10/19/rack-0.7.html                                     { return 301 https://$host/blog/rack-0.7/ ; }
    location /blog/convox-0-5-multi-region-vpcs-process-scaling-and-databases   { return 301 https://$host/blog/convox-0.5/ ; }
    location /blog/rack-0-7-papertrail-and-ssl                                  { return 301 https://$host/blog/rack-0.7/ ; }

    location /blog/blog/introducing-grid                                        { return 301 https://$host/blog/introducing-grid/ ; }
    location /blog/blog/rack-0.6                                                { return 301 https://$host/blog/rack-0.6/ ; }
    location /blog/blog/rack-0.7                                                { return 301 https://$host/blog/rack-0.7/ ; }

    location /convox/rack                                                       { return 301 https://$host/docs/rack/ ; }

    location /docs/api                                                          { return 301 https://$host/api/ ; }
    location /docs/cluster-instances                                            { return 301 https://$host/docs/installing-a-rack/ ; }
    location /docs/concepts                                                     { return 301 https://$host/docs/rack/ ; }
    location /docs/developing-locally                                           { return 301 https://$host/docs/preparing-an-application/ ; }
    location /docs/environment-variables                                        { return 301 https://$host/docs/environment/ ; }
    location /docs/getting-started-with-docker                                  { return 301 https://$host/docs/preparing-an-application/ ; }
    location /docs/getting-started-with-go                                      { return 301 https://$host/docs/preparing-an-application/ ; }
    location /docs/getting-started-with-rails                                   { return 301 https://$host/docs/preparing-an-application/ ; }
    location /docs/github-integration                                           { return 301 https://$host/docs/console/ ; }
    location /docs/links                                                        { return 301 https://$host/docs/linking/ ; }
    location /docs/one-off-runs                                                 { return 301 https://$host/docs/one-off-processes/ ; }
    location /docs/other-languages                                              { return 301 https://$host/docs/preparing-an-application/ ; }
    location /docs/papertrail                                                   { return 301 https://$host/docs/syslog/ ; }
    location /docs/pricing                                                      { return 301 https://$host/cost/ ; }
    location /docs/private-networking                                           { return 301 https://$host/docs/installing-a-rack/ ; }
    location /docs/rack-sharing                                                 { return 301 https://$host/docs/console/ ; }
    location /docs/scaling-apps                                                 { return 301 https://$host/docs/scaling/ ; }
    location /docs/scaling-rack                                                 { return 301 https://$host/docs/scaling/ ; }
    location /docs/slack                                                        { return 301 https://$host/docs/console/ ; }
    location /docs/troubleshooting-apps                                         { return 301 https://$host/docs/troubleshooting/ ; }
    location /docs/troubleshooting-install                                      { return 301 https://$host/docs/troubleshooting/ ; }
    location /docs/uninstall-a-rack                                             { return 301 https://$host/docs/uninstalling-convox/ ; }
    location /docs/uninstall-convox                                             { return 301 https://$host/docs/uninstalling-convox/ ; }
    location /docs/uninstall-rack                                               { return 301 https://$host/docs/uninstalling-convox/ ; }
    location /docs/updating-convox                                              { return 301 https://$host/docs/installing-a-rack/ ; }
    location /docs/using-the-cli-installer                                      { return 301 https://$host/docs/installing-a-rack/ ; }
    location /docs/what-is-a-rack                                               { return 301 https://$host/docs/rack/ ; }

    location /docs/docs/creating-an-iam-user                                    { return 301 https://$host/docs/creating-an-iam-user/ ; }
    location /docs/docs/custom-domains                                          { return 301 https://$host/docs/custom-domains/ ; }
    location /docs/docs/deleting-an-iam-user                                    { return 301 https://$host/docs/deleting-an-iam-user/ ; }
    location /docs/docs/deploying-an-application                                { return 301 https://$host/docs/deploying-to-convox/ ; }
    location /docs/docs/developing-locally                                      { return 301 https://$host/docs/preparing-an-application/ ; }
    location /docs/docs/environment-variables                                   { return 301 https://$host/docs/environment/ ; }
    location /docs/docs/getting-started-with-convox                             { return 301 https://$host/docs/getting-started/ ; }
    location /docs/docs/getting-started-with-docker                             { return 301 https://$host/docs/preparing-an-application/ ; }
    location /docs/docs/getting-started-with-go                                 { return 301 https://$host/docs/preparing-an-application/ ; }
    location /docs/docs/getting-started-with-golang                             { return 301 https://$host/docs/preparing-an-application/ ; }
    location /docs/docs/getting-started-with-rails                              { return 301 https://$host/docs/preparing-an-application/ ; }
    location /docs/docs/one-off-runs                                            { return 301 https://$host/docs/one-off-processes/ ; }
    location /docs/docs/postgresql                                              { return 301 https://$host/docs/postgresql/ ; }
    location /docs/docs/redis                                                   { return 301 https://$host/docs/redis/ ; }
    location /docs/docs/scaling-processes                                       { return 301 https://$host/docs/scaling/ ; }
    location /docs/docs/support                                                 { return 301 https://$host/docs/support/ ; }
    location /docs/docs/troubleshooting-apps                                    { return 301 https://$host/docs/troubleshooting/ ; }
    location /docs/docs/troubleshooting-install                                 { return 301 https://$host/docs/troubleshooting/ ; }
    location /docs/docs/updating-convox                                         { return 301 https://$host/docs/installing-a-rack/ ; }

    location /privacy                                                           { return 301 https://$host/legal/privacy ; }
  }
}
